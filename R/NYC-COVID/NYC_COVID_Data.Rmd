---
title: "COVID Data"
output: html_notebook
---

Purpose: To collect different local indicators of COVID prevalence and severity, and display them together.

#. take files containing CDC wastewater data from individual sewersheds
#. [TODO] take new simple data from typed entry or from the web
#. normalize data to a given date
#. plot the data over time

```{r setup}
require(tidyverse) # for reading and parsing
require(tcltk) # for file choosing
require(here) # for file choosing

```

# Input
The Sample Data folder will contain examples of files in the correct format.

. sewershed data from CDC
. TODO: case, positivity, and hospitalization data from NYC

```{r identify data files}

# ---- User chooses the input folder ----

datafolder <- tk_choose.dir(default = "", caption = "OPEN the folder with source data") # prompt user

files <- dir(datafolder, pattern = "*.csv") # Get a list of csv files in the folder

wastewaterFiles <- files[grepl("sarscov-2_rna_levels", files)]

print("We have the following wastewater data files:")
wastewaterFiles
```

```{r collect wastewater data}

# extract the sewershed ID which is a group of numbers after "sewershed_"

sewershedIDs <- wastewaterFiles %>% 
  str_match_all(regex("sewershed_(?<ID>[0-9]*)_")) %>%
   sapply("[[", 2)

```

``` {r read wastewater data}

# First try: get the data from one sewershed
rawDataOne <- read_csv(file.path(datafolder,wastewaterFiles[1]), col_types = cols(Date = col_date("%m/%d/%y"), Conc = col_double()), skip = 2) %>% `colnames<-`(c("Date", sewershedIDs[1]))

# TODO: 

# Second try: Use apply functions to iterate through the file list and make a df for each sewershed
rawDataAll <- read_csv(file.path(datafolder,wastewaterFiles), col_types = cols(Date = col_date("%m/%d/%y"), Conc = col_double()), skip = 2) %>% `colnames<-`(c("Date", sewershedIDs[1]))
# TODO: Use suggestion here https://stackoverflow.com/questions/62928897/r-merge-multiple-dataframes-by-date-without-repeating-dates to merge the data to get a single date column and multiple sewersheds 
# TODO: hide parsing errors because they are not serious so far 
```